<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç§˜å¯†ã®ãƒãƒˆãƒ«ã‚·ãƒƒãƒ— 7x7</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #f0f0f0; margin: 10px; }
        .game-container { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(7, 40px); 
            grid-template-rows: repeat(7, 40px);
            gap: 2px; background-color: #333; width: fit-content; border: 3px solid #333;
            margin: 0 auto;
        }

        /* ã‚¹ãƒãƒ›ç”¨ã‚µã‚¤ã‚ºèª¿æ•´ */
        @media (max-width: 400px) {
            .grid {
                grid-template-columns: repeat(7, 11vw);
                grid-template-rows: repeat(7, 11vw);
            }
        }

        .cell {
            width: 100%; height: 100%; background-color: #0077be;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 12px;
        }
        .ship { background-color: #777 !important; }
        
        .btn { padding: 12px 24px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; color: white; font-weight: bold; }
        .btn-ready { background-color: #4CAF50; box-shadow: 0 4px #2e6631; }
        .btn-ready:active { transform: translateY(2px); box-shadow: none; }
        .btn-join { background-color: #2196F3; }

        #setup-screen { margin-top: 50px; }
        #game-screen { display: none; }
        input { padding: 12px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; width: 80%; max-width: 300px; margin-bottom: 15px; }
        #status-msg { font-weight: bold; margin: 15px 0; min-height: 1.2em; }
    </style>
</head>
<body>
    <div id="setup-screen">
        <h1>ğŸš¢ ç§˜å¯†ã®å¯¾æˆ¦</h1>
        <p>åˆè¨€è‘‰ã‚’æ±ºã‚ã¦ã€ç›¸æ‰‹ã¨åŒã˜è¨€è‘‰ã‚’å…¥ã‚Œã¦ã­ï¼š</p>
        <input type="text" id="room-input" placeholder="ä¾‹ï¼šãƒ‘ãƒ‘123">
        <br>
        <button class="btn btn-join" onclick="joinRoom()">å¯¾æˆ¦ãƒ«ãƒ¼ãƒ ã«å…¥ã‚‹</button>
    </div>

    <div id="game-screen">
        <h2 id="room-display" style="font-size: 16px; color: #666;"></h2>
        <div>
            <button id="done-button" class="btn btn-ready" onclick="finishSetup()">èˆ¹ã®é…ç½®ã‚’å®Œäº†ã™ã‚‹</button>
            <p id="status-msg">è‡ªåˆ†ã®æµ·ã«èˆ¹ã‚’ç½®ã„ã¦ã­ï¼</p>
        </div>

        <div class="game-container">
            <div>
                <h3>è‡ªåˆ†ã®æµ·</h3>
                <div id="my-grid" class="grid"></div>
            </div>
            <div>
                <h3>ç›¸æ‰‹ã®æµ· (æ”»æ’ƒï¼)</h3>
                <div id="enemy-grid" class="grid"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const myGrid = document.getElementById('my-grid');
        const enemyGrid = document.getElementById('enemy-grid');
        const statusMsg = document.getElementById('status-msg');
        
        let isSetupMode = true; 
        let isMyTurn = false; 
        let isGameStarted = false; // â˜…è¿½åŠ ï¼šäºŒäººæƒã£ãŸã‹
        let myShipsHit = 0;      
        let enemyShipsHit = 0;   
        let enemyShipsTotal = 0; 
        const myShips = []; 

        function joinRoom() {
            const roomName = document.getElementById('room-input').value;
            if (!roomName) { alert("åˆè¨€è‘‰ã‚’å…¥ã‚Œã¦ã­ï¼"); return; }
            socket.emit('join-room', roomName);
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('room-display').textContent = "ç¾åœ¨ã®éƒ¨å±‹ï¼š" + roomName;
        }

        for (let i = 0; i < 49; i++) {
            const myCell = document.createElement('div');
            myCell.classList.add('cell');
            myCell.addEventListener('click', () => {
                if (isSetupMode) {
                    if (!myShips.includes(i)) { myCell.classList.add('ship'); myShips.push(i); }
                    else { myCell.classList.remove('ship'); myShips.splice(myShips.indexOf(i), 1); }
                }
            });
            myGrid.appendChild(myCell);

            const enemyCell = document.createElement('div');
            enemyCell.classList.add('cell');
            enemyCell.addEventListener('click', () => {
                // â˜…2äººæƒã£ã¦ã„ãªã„ï¼ˆ!isGameStartedï¼‰ã¨ãã¯æ”»æ’ƒã§ããªã„
                if (!isSetupMode && isMyTurn && isGameStarted) {
                    socket.emit('attack', i);
                    enemyCell.style.backgroundColor = 'white';
                    enemyCell.textContent = '...';
                    isMyTurn = false;
                    statusMsg.textContent = "ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã§ã™...";
                } else if (!isSetupMode && isMyTurn && !isGameStarted) {
                    alert("ç›¸æ‰‹ãŒæº–å‚™ã§ãã‚‹ã¾ã§å¾…ã£ã¦ã­ï¼");
                } else if (!isSetupMode && !isMyTurn) {
                    alert("ä»Šã¯ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã§ã™ï¼");
                }
            });
            enemyGrid.appendChild(enemyCell);
        }

        function finishSetup() {
            if (myShips.length === 0) { alert("èˆ¹ã‚’ç½®ã„ã¦ã­ï¼"); return; }
            isSetupMode = false;
            document.getElementById('done-button').style.display = 'none';
            socket.emit('ready', { shipCount: myShips.length });
            statusMsg.textContent = "ç›¸æ‰‹ã®æº–å‚™ã‚’å¾…ã£ã¦ã„ã¾ã™...";
        }

        // 2äººæƒã£ãŸåˆå›³
        socket.on('game-start', () => {
            isGameStarted = true;
            statusMsg.textContent += "ã€å¯¾æˆ¦é–‹å§‹ï¼ã€‘";
        });

        socket.on('enemy-ship-count', (data) => {
            if (data.id !== socket.id) enemyShipsTotal = data.shipCount;
        });

        socket.on('order-decision', (order) => {
            isMyTurn = (order === 1);
            statusMsg.textContent = isMyTurn ? "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ï¼" : "ã‚ãªãŸã¯å¾Œæ”»ã§ã™ã€‚";
            statusMsg.style.color = isMyTurn ? "red" : "black";
        });
        
        socket.on('attack', (idx) => {
            let res = myShips.includes(idx) ? "hit" : "miss";
            const cell = myGrid.children[idx];
            cell.style.backgroundColor = (res === "hit") ? 'red' : '#e0f7fa';
            cell.textContent = (res === "hit") ? 'ğŸ’¥' : 'ğŸŒŠ';
            if (res === "hit") myShipsHit++;

            if (myShipsHit < myShips.length) {
                isMyTurn = true;
                statusMsg.textContent = "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ï¼";
                statusMsg.style.color = "red";
            } else {
                statusMsg.textContent = "å…¨æ»…ã—ã¾ã—ãŸ... æ•—åŒ—ï¼";
                isMyTurn = false;
            }
            socket.emit('result', { index: idx, status: res });
        });

        socket.on('result', (data) => {
            const cell = enemyGrid.children[data.index];
            cell.style.backgroundColor = (data.status === "hit") ? 'red' : '#e0f7fa';
            cell.textContent = (data.status === "hit") ? 'ğŸ’¥' : 'ğŸŒŠ';
            if (data.status === "hit") {
                enemyShipsHit++;
                if (enemyShipsTotal > 0 && enemyShipsHit === enemyShipsTotal) {
                    statusMsg.textContent = "å‹åˆ©ï¼ğŸ† ãŠã‚ã§ã¨ã†ï¼";
                    statusMsg.style.color = "blue";
                    isMyTurn = false;
                }
            }
        });
    </script>
</body>
</html>